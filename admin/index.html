<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Star Wars TTRPG (локальный редактор)</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#0f1520; --border:#223044; --text:#e6e8eb; --muted:#a6b0bf; }
    *{box-sizing:border-box} body{margin:0;background:#0b0f14;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    h1{margin:0 0 12px} h2{margin:18px 0 8px} h3{margin:12px 0 8px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.12)), var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin:12px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap} .col{flex:1 1 320px}
    label{display:block; margin:8px 0 4px; color:var(--muted)}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#0e1520; color:var(--text);
    }
    input[type="color"]{height:36px;width:64px;padding:0;border:1px solid var(--border);border-radius:8px;background:#0e1520}
    textarea{min-height:100px; font-family: ui-monospace,Consolas,monospace}
    .btn{appearance:none; background:#111a26; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{border-color:#3a4a66}
    .list{display:grid; gap:10px}
    .item{border:1px dashed var(--border); border-radius:10px; padding:10px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:#1a2638; margin:16px 0}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0c131e; color:var(--muted); font-size:12px}
    .danger{color:#ff7b7b} .ok{color:#90e39a}
    code{background:#0f1826; padding:2px 6px; border-radius:6px; border:1px solid #1c2a40}
    .note{font-size:13px}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Админка (без авторизации)</h1>
    <p class="note">Эта страница правит JSON-файлы в браузере. После правок нажмите <strong>Скачать</strong> и загрузите файлы в GitHub вручную.</p>

    <div class="card">
      <div class="row">
        <button id="btn-load" class="btn">Загрузить текущее содержимое</button>
        <button id="btn-save-all" class="btn primary">Скачать ВСЕ (3 файла)</button>
        <span id="status" class="tag">готово</span>
      </div>
      <p class="note">Файлы: <code>content/sections.json</code>, <code>content/callouts.json</code>, <code>content/tables.json</code></p>
    </div>

    <div class="card">
      <div class="row"><h2>Разделы страницы</h2><button id="add-section" class="btn">+ Добавить раздел</button></div>
      <div id="sections" class="list"></div>
      <div class="hr"></div>
      <div class="row"><button id="download-sections" class="btn primary">Скачать sections.json</button></div>
    </div>

    <div class="card">
      <div class="row"><h2>Особые секции (Callouts)</h2><button id="add-callout" class="btn">+ Добавить callout</button></div>
      <div id="callouts" class="list"></div>
      <div class="hr"></div>
      <div class="row"><button id="download-callouts" class="btn primary">Скачать callouts.json</button></div>
    </div>

    <div class="card">
      <div class="row"><h2>Таблицы</h2><button id="add-table" class="btn">+ Добавить таблицу</button></div>
      <div id="tables" class="list"></div>
      <div class="hr"></div>
      <div class="row"><button id="download-tables" class="btn primary">Скачать tables.json</button></div>
    </div>

    <p class="muted">Подсказка: поле <code>order</code> задаёт порядок блоков (1,2,3…)</p>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const el = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };
    const label = t => { const l=document.createElement('label'); l.textContent=t; return l; };
    const download = (filename, text) => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); };
    const status = (msg, ok=true) => { const s=$("#status"); s.textContent=msg; s.className="tag "+(ok?"ok":"danger"); };

    let sections={items:[]}, callouts={items:[]}, tables={items:[]};

    async function loadAll(){
      try{
        const [s,c,t] = await Promise.all([
          fetch('../content/sections.json',{cache:'no-cache'}).then(r=>r.json()),
          fetch('../content/callouts.json',{cache:'no-cache'}).then(r=>r.json()),
          fetch('../content/tables.json',{cache:'no-cache'}).then(r=>r.json())
        ]);
        sections=s; callouts=c; tables=t;
        renderSections(); renderCallouts(); renderTables();
        status("загружено");
      }catch(e){ console.error(e); status("ошибка загрузки", false); }
    }

    function fieldText(lbl, val, on){
      const wrap=el('div'); wrap.appendChild(label(lbl));
      const i=el('input'); i.type='text'; i.value=(val??''); i.oninput=e=>on(e.target.value); wrap.appendChild(i); return wrap;
    }
    function fieldNum(lbl, val, on){
      const wrap=el('div'); wrap.appendChild(label(lbl));
      const i=el('input'); i.type='number'; i.value=(val??0); i.oninput=e=>on(+e.target.value); wrap.appendChild(i); return wrap;
    }
    function fieldColor(lbl, val, on){
      const wrap=el('div'); wrap.appendChild(label(lbl));
      const row=el('div','grid2');
      const i=el('input'); i.type='color'; i.value=(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val||'')?val:'#ffffff'); i.oninput=e=>{ txt.value=e.target.value; on(e.target.value); };
      const txt=el('input'); txt.type='text'; txt.value=val||''; txt.oninput=e=>on(e.target.value);
      row.appendChild(i); row.appendChild(txt); wrap.appendChild(row); return wrap;
    }
    function fieldArea(lbl, val, on){
      const wrap=el('div'); wrap.appendChild(label(lbl));
      const a=el('textarea'); a.value=val||''; a.oninput=e=>on(e.target.value); wrap.appendChild(a); return wrap;
    }
    function fieldSelect(lbl, val, options, on){
      const wrap=el('div'); wrap.appendChild(label(lbl));
      const s=el('select'); options.forEach(o=>{ const op=el('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; s.appendChild(op); });
      s.oninput=e=>on(e.target.value); wrap.appendChild(s); return wrap;
    }
    function removeBtn(on){ const b=el('button','btn'); b.textContent='Удалить'; b.onclick=on; b.style.marginTop='8px'; return b; }

    function styleGroup(obj, isCallout=false){
      obj.style = obj.style || {};
      const box=el('div','card'); box.appendChild(label('Стиль (необязательно)'));
      const row1=el('div','row');
      row1.appendChild(fieldNum('Верхний отступ (px)', obj.style.mt??16, v=>obj.style.mt=v));
      row1.appendChild(fieldNum('Нижний отступ (px)', obj.style.mb??16, v=>obj.style.mb=v));
      row1.appendChild(fieldNum('Внутренний отступ (px)', obj.style.pad??(isCallout?12:18), v=>obj.style.pad=v));
      box.appendChild(row1);

      const row2=el('div','row');
      row2.appendChild(fieldColor('Цвет текста', obj.style.text??'', v=>obj.style.text=v));
      if(isCallout){
        row2.appendChild(fieldColor('Цвет полосы слева', obj.style.bar??'', v=>obj.style.bar=v));
      } else {
        row2.appendChild(fieldColor('Цвет акцента', obj.style.accent??'', v=>obj.style.accent=v));
      }
      row2.appendChild(fieldColor('Фон панели', obj.style.bg??'', v=>obj.style.bg=v));
      box.appendChild(row2);

      const row3=el('div','row');
      row3.appendChild(fieldText('Фоновое изображение (URL)', obj.style.bgImage??'', v=>obj.style.bgImage=v));
      row3.appendChild(fieldText('Шрифт заголовков', obj.style.fontHead??'Russo One', v=>obj.style.fontHead=v));
      row3.appendChild(fieldText('Шрифт текста', obj.style.fontBody??'Montserrat', v=>obj.style.fontBody=v));
      box.appendChild(row3);

      // Спец-стили для таблиц
      if(obj.columns || obj.rows){
        const row4=el('div','row');
        row4.appendChild(fieldColor('Цвет шапки таблицы', obj.style.head??'', v=>obj.style.head=v));
        row4.appendChild(fieldColor('Цвет границ таблицы', obj.style.border??'', v=>obj.style.border=v));
        box.appendChild(row4);
      }
      return box;
    }

    function renderSections(){
      const root=$("#sections"); root.innerHTML="";
      (sections.items||[]).forEach((it,idx)=>{
        const item=el('div','item');
        item.appendChild(fieldText('Заголовок', it.title, v=>it.title=v));
        item.appendChild(fieldNum('Порядок', it.order||1, v=>it.order=v));
        item.appendChild(fieldArea('Содержимое (Markdown)', it.body||'', v=>it.body=v));
        item.appendChild(styleGroup(it, false));
        item.appendChild(removeBtn(()=>{ sections.items.splice(idx,1); renderSections(); }));
        root.appendChild(item);
      });
    }
    function renderCallouts(){
      const root=$("#callouts"); root.innerHTML="";
      (callouts.items||[]).forEach((it,idx)=>{
        const item=el('div','item');
        item.appendChild(fieldText('Заголовок', it.title||'Внимание', v=>it.title=v));
        item.appendChild(fieldNum('Порядок', it.order||10, v=>it.order=v));
        item.appendChild(fieldSelect('Вариант', it.variant||'warning', ['warning','info','success','danger'], v=>it.variant=v));
        item.appendChild(fieldArea('Текст (Markdown)', it.text||'', v=>it.text=v));
        item.appendChild(styleGroup(it, true));
        item.appendChild(removeBtn(()=>{ callouts.items.splice(idx,1); renderCallouts(); }));
        root.appendChild(item);
      });
    }
    function renderTables(){
      const root=$("#tables"); root.innerHTML="";
      (tables.items||[]).forEach((it,idx)=>{
        const item=el('div','item');
        item.appendChild(fieldText('Заголовок', it.title||'Таблица', v=>it.title=v));
        item.appendChild(fieldNum('Порядок', it.order||20, v=>it.order=v));
        // Columns editor
        const cw=el('div'); cw.appendChild(label('Колонки (по одной на строку)'));
        const taCols=document.createElement('textarea'); taCols.value=(it.columns||[]).join('\n');
        taCols.oninput=e=>{ it.columns = e.target.value.split('\n').map(x=>x.trim()).filter(Boolean); };
        cw.appendChild(taCols); item.appendChild(cw);
        // Rows editor
        const rw=el('div'); rw.appendChild(label('Строки (формат: c1|c2|c3|c4|c5|c6)'));
        const taRows=document.createElement('textarea');
        taRows.value=(it.rows||[]).map(r=>[r.c1,r.c2,r.c3,r.c4,r.c5,r.c6].filter(x=>x!==undefined).join('|')).join('\n');
        taRows.oninput=e=>{
          it.rows = e.target.value.split('\n').map(line=>{
            const p=line.split('|'); return { c1:p[0]||'', c2:p[1]||'', c3:p[2]||'', c4:p[3], c5:p[4], c6:p[5] };
          }).filter(r=> (r.c1||r.c2||r.c3));
        };
        rw.appendChild(taRows); item.appendChild(rw);
        item.appendChild(styleGroup(it, false));
        item.appendChild(removeBtn(()=>{ tables.items.splice(idx,1); renderTables(); }));
        root.appendChild(item);
      });
    }

    // add buttons
    $("#add-section").onclick = ()=>{ sections.items.push({ title:"Новый раздел", order:(sections.items.length?sections.items.length+1:1), body:"", style:{} }); renderSections(); };
    $("#add-callout").onclick = ()=>{ callouts.items.push({ title:"Внимание", order:(callouts.items.length?callouts.items.length+10:10), variant:"warning", text:"", style:{} }); renderCallouts(); };
    $("#add-table").onclick = ()=>{ tables.items.push({ title:"Новая таблица", order:(tables.items.length?tables.items.length+20:20), columns:["C1","C2","C3"], rows:[], style:{} }); renderTables(); };

    // downloads
    $("#download-sections").onclick = ()=> download('sections.json', JSON.stringify(sections,null,2));
    $("#download-callouts").onclick = ()=> download('callouts.json', JSON.stringify(callouts,null,2));
    $("#download-tables").onclick = ()=> download('tables.json', JSON.stringify(tables,null,2));
    $("#btn-save-all").onclick = ()=>{
      $("#download-sections").click();
      setTimeout(()=>$("#download-callouts").click(), 200);
      setTimeout(()=>$("#download-tables").click(), 400);
    };

    $("#btn-load").onclick = loadAll;
    // auto-load current content
    loadAll();
  </script>
</body>
</html>
